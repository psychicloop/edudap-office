{% extends "base.html" %}
{% block content %}
<div class="container">
    {% if current_user.role == 'Admin' %}
    <div class="card border-0 shadow-sm mb-4" style="background-color: #f8fcfd; border-left: 5px solid var(--edudap-blue);">
        <div class="card-body">
            <h5 class="fw-bold mb-3" style="color: var(--edudap-blue);"><i class="bi bi-person-plus-fill me-2"></i>Assign New Task</h5>
            <form method="POST" class="row g-3">
                <input type="hidden" name="assign_task" value="1">
                <div class="col-md-4"><label class="small text-muted fw-bold">Task Title</label><input type="text" name="title" class="form-control" required></div>
                <div class="col-md-3"><label class="small text-muted fw-bold">Assign To</label><select name="employee_id" class="form-select" required><option value="">Select...</option>{% for emp in employees %}<option value="{{ emp.id }}">{{ emp.username }}</option>{% endfor %}</select></div>
                <div class="col-md-3"><label class="small text-muted fw-bold">Deadline</label><input type="datetime-local" name="deadline" class="form-control"></div>
                <div class="col-md-2 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100 fw-bold">Assign</button></div>
                <div class="col-12"><textarea name="description" class="form-control" placeholder="Detailed instructions..." rows="2"></textarea></div>
            </form>
        </div>
    </div>
    {% endif %}

    <h5 class="fw-bold text-muted mb-3"><i class="bi bi-list-task me-2"></i>Task Timeline</h5>
    {% if tasks %}
    <div class="row g-4">
        {% for task in tasks %}
        <div class="col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <div><span class="badge {{ 'bg-success' if task.status == 'Completed' else 'bg-warning text-dark' }}">{{ task.status }}</span>{% if current_user.role == 'Admin' %}<span class="badge bg-light text-dark border ms-1">{{ task.assigned_to.username }}</span>{% endif %}</div>
                    {% if task.deadline %}<small class="text-danger fw-bold">Due: {{ task.deadline.strftime('%d %b %H:%M') }}</small>{% endif %}
                </div>
                <div class="card-body">
                    <h5 class="card-title fw-bold">{{ task.title }}</h5>
                    <p class="card-text text-muted small">{{ task.description }}</p>
                    <hr>
                    <div class="bg-white p-4 rounded mb-3 border" style="height: 500px; overflow-y: auto; font-size: 1.05rem; font-family: 'Segoe UI', sans-serif; box-shadow: inset 0 0 10px rgba(0,0,0,0.03);">
                        {% if task.chat_history %}<pre style="white-space: pre-wrap; font-family: inherit; margin: 0; color: #444; line-height: 1.6;">{{ task.chat_history }}</pre>{% else %}<span class="text-muted fst-italic">No updates yet.</span>{% endif %}
                    </div>
                    <form method="POST" class="d-flex gap-2">
                        <input type="hidden" name="update_chat" value="1"><input type="hidden" name="task_id" value="{{ task.id }}">
                        <input type="text" name="message" class="form-control form-control-lg" placeholder="Type a note/reply..." required>
                        {% if current_user.role != 'Admin' %}<select name="status" class="form-select form-select-sm" style="width: 130px;"><option value="In Progress">In Progress</option><option value="Completed">Completed</option></select>{% endif %}
                        <button type="submit" class="btn btn-dark btn-lg"><i class="bi bi-send-fill"></i></button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}<div class="text-center py-5"><p class="text-muted">No tasks assigned yet.</p></div>{% endif %}
</div>
{% endblock %}
