
{% extends 'base.html' %}
{% block content %}
<h3>Leave Calendar</h3>
<div id="calendar"></div>
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css' rel='stylesheet'>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<style>
  #calendar{background:var(--paper); padding:10px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,.06)}
  .fc .fc-toolbar-title{color:var(--brand-navy)}
  .fc .fc-button-primary{background:var(--brand-navy); border-color:var(--brand-navy)}
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const el = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      height: 'auto',
      firstDay: 1,
      headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
      events: '/leave/events',
      selectable: true,
      selectMirror: true,
      unselectAuto: true,
      select: function(info){
        function toYMD(d){
          const dt = new Date(d);
          dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
          return dt.toISOString().slice(0,10);
        }
        const startYMD = info.startStr.slice(0,10);
        const endInc = new Date(info.endStr);
        endInc.setDate(endInc.getDate()-1);
        const endYMD = toYMD(endInc);
        document.getElementById('leave_start').value = startYMD;
        document.getElementById('leave_end').value = endYMD;
        const modalEl = document.getElementById('createLeaveModal');
        const m = new bootstrap.Modal(modalEl);
        m.show();
        modalEl.addEventListener('hidden.bs.modal', function(){ calendar.unselect(); }, {once:true});
      },
      eventClick: function(info){
        const e = info.event; const props = e.extendedProps || {};
        const body = `Status: ${props.status || ''}<br>Reason: ${props.reason || ''}`;
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.innerHTML = `          <div class="modal-dialog">            <div class="modal-content">              <div class="modal-header"><h5 class="modal-title">${e.title}</h5>                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>              </div>              <div class="modal-body">${body}</div>            </div>          </div>`;
        document.body.appendChild(modal);
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        modal.addEventListener('hidden.bs.modal', ()=>modal.remove());
      }
    });
    calendar.render();
  });
</script>
<!-- Create Leave Modal -->
<div class="modal fade" id="createLeaveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{{ url_for('leave.request_leave') }}" id="createLeaveForm">
        <div class="modal-header">
          <h5 class="modal-title">Create Leave</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Start date</label>
              <input type="date" class="form-control" name="start_date" id="leave_start" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">End date</label>
              <input type="date" class="form-control" name="end_date" id="leave_end" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Leave type</label>
              <input type="text" class="form-control" name="leave_type" id="leave_type" placeholder="Sick/Casual/etc.">
            </div>
            <div class="col-12">
              <label class="form-label">Reason</label>
              <textarea class="form-control" name="reason" id="leave_reason" rows="3" placeholder="Optional"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
